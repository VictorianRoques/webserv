#!/usr/local/bin/python3

import socket
import time
import threading
import sys

lock = threading.Lock()

########################################
#               VARIABLES              #
########################################

hostname = 'localhost'
port = 8080
test = ""
if len(sys.argv) < 2:
	print('error: usage: ./webserv port [get, post, delete, stress1, stress2, chunk, memory, leak')
	exit(1)
elif len(sys.argv) == 2:
	port = int(sys.argv[1])
elif len(sys.argv) == 3:
	test = str(sys.argv[2])
elif len(sys.argv) > 3:
	print('error: too many arguments')

########################################
#               FUNCTIONS              #
########################################

def is_server_up(hostname, port):
	sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
	sock.settimeout(3)
	sock.connect((hostname, port))
	sock.send(b'Check if server is up')
	try:
		sock.recv(4096)
		return True
	except:
		return False

def get_tester():
	sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
	sock.connect((hostname, port))
	sock.settimeout(3)
	sock.send(b'GET / HTTP/1.1\r\n\
Host: ' + bytes(hostname, 'utf-8') + b':' + bytes(str(port), 'utf-8') + b'\r\n\
User-Agent: webserv_tester\r\n\
Connection: keep-alive\r\n\r\n')
	ret = sock.recv(4096)
	print(ret)

def post_text_tester():
	sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
	sock.connect((hostname, port))
	sock.settimeout(3)
	sock.send(b'POST / HTTP/1.1\r\n\
Host: ' + bytes(hostname, 'utf-8') + b':' + bytes(str(port), 'utf-8') + b'\r\n\
User-Agent: webserv_tester\r\n\
Content-Type: text/plain\r\n\
Content-Length: 12\r\n\
Connection: keep-alive\r\n\
\r\n\
Hello World!\r\n\
\r\n')
	ret = sock.recv(4096)
	print(ret)

def delete_tester():
	pathDelete = input('enter path to file you want to delete: ')
	sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
	sock.connect((hostname, port))
	sock.settimeout(3)
	sock.send(b'DELETE ' + bytes(pathDelete, 'utf-8') + b' HTTP/1.1\r\n\r\n')
	ret = sock.recv(4096)
	print(ret)

def stress1_tester():
	socks = []
	for i in range(1500):
		time.sleep(0.005)
		socks.append(socket.socket(socket.AF_INET, socket.SOCK_STREAM))
		socks[i].connect((hostname, port))
		socks[i].settimeout(3)
		socks[i].send(b'GET / HTTP/1.1\r\n\
Host: ' + bytes(hostname, 'utf-8') + b':' + bytes(str(port), 'utf-8') + b'\r\n\
User-Agent: webserv_tester\r\n\
Accept-Encoding: *\r\n\
Accept: */*\r\n\
Connection: keep-alive\r\n\r\n')
		socks[i].recv(4096)
		strg = 'socket ' + str(i) + ': data received from server'
		lock.acquire()
		print("                                                  ", end='\r')
		print(strg, end='\r')
		lock.release()
		strg = 'socket ' + str(i) + ': cannot receive data from server'
		print("                                                  ", end='\r')
		print(strg, end='\r')

def stress2_tester():
	thread1 = threading.Thread(target=stress1_tester)
	thread2 = threading.Thread(target=stress1_tester)
	print('Thread 1 starting...')
	thread1.start()
	time.sleep(3)
	lock.acquire()
	print('                                                  ', end='\r')
	print('Thread 2 starting...')
	lock.release()
	thread2.start()
	thread1.join()
	thread2.join()

def chunk_tester():
	sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
	sock.connect((hostname, port))
	sock.send(b'POST / HTTP/1.1\r\n\
Host: ' + bytes(hostname, 'utf-8') + b':' + bytes(str(port), 'utf-8') + b'\r\n\
User-Agent: webserv_tester\r\n\
Content-Type: application/x-www-form-urlencoded\r\n\
Accept-Encoding: *\r\n\
Accept: */*\r\n\
Connection: keep-alive\r\n\
Transfer-Encoding: chunked\r\n\r\n\
9\r\n\
name=Foo&\r\n\r\n')
	time.sleep(0.01)
	sock.send(b'B\r\n\
message=Bar\r\n\r\n')
	time.sleep(0.01)
	sock.send(b'0\r\n\r\n')
	ret = sock.recv(4096)
	print(ret)

def large_payload_tester():
	sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
	sock.connect((hostname, port))
	sock.send(b'POST / HTTP/1.1\r\n\
Host: ' + bytes(hostname, 'utf-8') + b':' + bytes(str(port), 'utf-8') + b'\r\n\
User-Agent: webserv_tester\r\n\
Accept-Encoding: *\r\n\
Accept: */*\r\n\
Connection: keep-alive\r\n\
Transfer-Encoding: chunked\r\n\r\n\
4\r\n\
yoyo\r\n\r\n')
	time.sleep(0.005)
	for i in range(3965 * 3):
		time.sleep(0.005)
		sock.send(b'3E8\r\n\
Phasellus consequat placerat tristique. Fusce vel eleifend tortor. Aenean egestas non risus et vehicula. Nam ac mauris odio. Maecenas convallis mi vel justo vehicula, a interdum leo porta. Mauris consequat nec urna sed aliquet. Aliquam aliquet, dui id hendrerit auctor, turpis ante facilisis sapien, sit amet interdum nibh ipsum et ex. Etiam vulputate in libero quis viverra. Nunc sit amet ipsum id ipsum scelerisque efficitur. Vivamus in sapien id tortor dapibus accumsan. Cras eleifend, est et vestibulum efficitur, lorem velit pulvinar mi, nec vehicula ligula nisl quis tortor. In sagittis sapien sit amet enim rutrum varius. Maecenas cursus justo a sapien blandit, sit amet tincidunt sem lacinia. Suspendisse bibendum tristique orci, et ornare massa mollis sit amet. Aenean dictum, turpis vitae varius auctor, arcu mi malesuada libero, et ullamcorper dolor justo in turpis. Pellentesque vestibulum porttitor porta. Phasellus consequat placerat tristique. Phasellus consequat placerat tristique...\r\n\r\n')
	time.sleep(0.005)
	sock.send(b'0\r\n\r\n')
	ret = sock.recv(4096)
	print(ret)

def leak_tester():
	for i in range(10000):
		sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
		sock.connect((hostname, port))
		sock.send(b'GET / HTTP/1.1\r\n\
Host: ' + bytes(hostname, 'utf-8') + b':' + bytes(str(port), 'utf-8') + b'\r\n\
User-Agent: webserv_tester\r\n\
Connection: keep-alive\r\n\r\n')
		time.sleep(0.001)

########################################
#               EXEC_FCTS              #
########################################

tester = dict()
tester['is_server_up'] = is_server_up
tester['get_tester'] = get_tester
tester['post_text_tester'] = post_text_tester
tester['delete_tester'] = delete_tester
tester['stress1_tester'] = stress1_tester
tester['stress2_tester'] = stress2_tester
tester['chunk_tester'] = chunk_tester
tester['large_payload_tester'] = large_payload_tester

def up():
	name = 'is_server_up'
	print('\033[1;34m\n--------------------------------')
	print('    ' + name.upper() + ' starting...')
	print('--------------------------------\033[0m')
	time.sleep(0.5)
	try:
		tester[name]()
	except:
		print('[ \033[1;31m error: ' + name + '\033[0m ]')
	print('\n' + name.upper(), end='\r')
	ret = is_server_up(hostname, port)
	time.sleep(0.5)
	if ret:
		print(name.upper() + ' [ \033[1;32mOK\033[0m ]')
	else:
		print(name.upper() + ' [ \033[1;31mKO\033[0m ]')

def get():
	name = 'get_tester'
	print('\033[1;34m\n--------------------------------')
	print('    ' + name.upper() + ' starting...')
	print('--------------------------------\033[0m')
	time.sleep(0.5)
	tester[name]()
	print('\n' + name.upper(), end='\r')
	ret = is_server_up(hostname, port)
	time.sleep(0.5)
	if ret:
		print(name.upper() + ' [ \033[1;32mOK\033[0m ]')
	else:
		print(name.upper() + ' [ \033[1;31mKO\033[0m ]')

def post_text():
	name = 'post_text_tester'
	print('\033[1;34m\n--------------------------------')
	print('    ' + name.upper() + ' starting...')
	print('--------------------------------\033[0m')
	time.sleep(0.5)
	tester[name]()
	print('\n' + name.upper(), end='\r')
	ret = is_server_up(hostname, port)
	time.sleep(0.5)
	if ret:
		print(name.upper() + ' [ \033[1;32mOK\033[0m ]')
	else:
		print(name.upper() + ' [ \033[1;31mKO\033[0m ]')

def delete():
	name = 'delete_tester'
	print('\033[1;34m\n--------------------------------')
	print('    ' + name.upper() + ' starting...')
	print('--------------------------------\033[0m')
	time.sleep(0.5)
	tester[name]()
	print('\n' + name.upper(), end='\r')
	ret = is_server_up(hostname, port)
	time.sleep(0.5)
	if ret:
		print(name.upper() + ' [ \033[1;32mOK\033[0m ]')
	else:
		print(name.upper() + ' [ \033[1;31mKO\033[0m ]')

def stress1():
	name = 'stress1_tester'
	print('\033[1;34m\n--------------------------------')
	print('    ' + name.upper() + ' starting...')
	print('--------------------------------\033[0m')
	time.sleep(0.5)
	tester[name]()
	print('\n' + name.upper(), end='\r')
	ret = is_server_up(hostname, port)
	time.sleep(0.5)
	if ret:
		print(name.upper() + ' [ \033[1;32mOK\033[0m ]')
	else:
		print(name.upper() + ' [ \033[1;31mKO\033[0m ]')

def stress2():
	name = 'stress2_tester'
	print('\033[1;34m\n--------------------------------')
	print('    ' + name.upper() + ' starting...')
	print('--------------------------------\033[0m')
	time.sleep(0.5)
	tester[name]()
	print('\n' + name.upper(), end='\r')
	ret = is_server_up(hostname, port)
	time.sleep(0.5)
	if ret:
		print(name.upper() + ' [ \033[1;32mOK\033[0m ]')
	else:
		print(name.upper() + ' [ \033[1;31mKO\033[0m ]')

def chunk():
	name = 'post_text_tester'
	print('\033[1;34m\n--------------------------------')
	print('    ' + name.upper() + ' starting...')
	print('--------------------------------\033[0m')
	time.sleep(0.5)
	tester[name]()
	print('\n' + name.upper(), end='\r')
	ret = is_server_up(hostname, port)
	time.sleep(0.5)
	if ret:
		print(name.upper() + ' [ \033[1;32mOK\033[0m ]')
	else:
		print(name.upper() + ' [ \033[1;31mKO\033[0m ]')

def large_payload():
	name = 'large_payload_tester'
	print('\033[1;34m\n--------------------------------')
	print('    ' + name.upper() + ' starting...')
	print('--------------------------------\033[0m')
	time.sleep(0.5)
	tester[name]()
	print('\n' + name.upper(), end='\r')
	ret = is_server_up(hostname, port)
	time.sleep(0.5)
	if ret:
		print(name.upper() + ' [ \033[1;32mOK\033[0m ]')
	else:
		print(name.upper() + ' [ \033[1;31mKO\033[0m ]')

########################################
#                  RUN                 #
########################################

print('[ hostname: ' + '\033[1;32m' + hostname + '\033[0m ]')
print('[ port: ' + '\033[1;32m' + str(port) + '\033[0m ]')
test_ = '[ test: ' + '\033[1;32m' + test + '\033[0m ]'
print(test_)
single_test = dict()
single_test['up'] = up
single_test['get'] = get
single_test['post_text'] = post_text
single_test['delete'] = delete
single_test['stress1'] = stress1
single_test['stress2'] = stress2
single_test['chunk'] = chunk
single_test['large_payload'] = large_payload

time.sleep(1)

if (test != ''):
	single_test[test]()
else:
	for key in single_test:
		single_test[key]()
